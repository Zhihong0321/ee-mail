<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EE-Mail Admin</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    .header {
      background: #1a1a2e;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 1.5rem; }
    .header .domain {
      background: #4a4a6a;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-card h3 {
      font-size: 2rem;
      color: #1a1a2e;
      margin-bottom: 0.5rem;
    }
    .stat-card p {
      color: #666;
      font-size: 0.875rem;
      text-transform: uppercase;
    }
    .actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #1a1a2e;
      color: white;
    }
    .btn-primary:hover { background: #2a2a4e; }
    .btn-secondary {
      background: white;
      color: #333;
      border: 1px solid #ddd;
    }
    .btn-secondary:hover { background: #f5f5f5; }
    .email-list {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .email-list-header {
      padding: 1rem 1.5rem;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .email-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      transition: background 0.2s;
      display: grid;
      grid-template-columns: 250px 1fr 150px;
      gap: 1rem;
      align-items: center;
    }
    .email-item:hover { background: #f8f9fa; }
    .email-item:last-child { border-bottom: none; }
    .email-from {
      font-weight: 500;
      color: #333;
    }
    .email-subject {
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .email-date {
      color: #999;
      font-size: 0.875rem;
      text-align: right;
    }
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 0.5rem;
    }
    .status-sent { background: #e3f2fd; color: #1976d2; }
    .status-delivered { background: #e8f5e9; color: #388e3c; }
    .status-bounced { background: #ffebee; color: #d32f2f; }
    .status-opened { background: #f3e5f5; color: #7b1fa2; }
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    .empty {
      text-align: center;
      padding: 3rem;
      color: #999;
    }
    .error {
      background: #ffebee;
      color: #d32f2f;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
    }
    .email-detail-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e9ecef;
    }
    .email-detail-header h2 {
      margin-bottom: 1rem;
    }
    .email-meta {
      display: grid;
      gap: 0.5rem;
      color: #666;
      font-size: 0.875rem;
    }
    .email-meta span {
      display: flex;
    }
    .email-meta strong {
      width: 80px;
      color: #333;
    }
    .email-content {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 6px;
      min-height: 200px;
    }
    .email-content iframe {
      width: 100%;
      min-height: 300px;
      border: none;
      background: white;
    }
    .attachments-section {
      margin: 1rem 0;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    .attachments-section h4 {
      margin-bottom: 0.75rem;
      color: #333;
      font-size: 0.9rem;
    }
    .attachments-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .attachment-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.875rem;
    }
    .attachment-item:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .attachment-icon {
      font-size: 1.25rem;
    }
    .attachment-info {
      display: flex;
      flex-direction: column;
    }
    .attachment-name {
      font-weight: 500;
      color: #333;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .attachment-size {
      font-size: 0.75rem;
      color: #666;
    }
    .attachment-actions {
      display: flex;
      gap: 0.25rem;
      margin-left: 0.5rem;
    }
    .attachment-btn {
      padding: 0.25rem 0.5rem;
      border: none;
      background: #e9ecef;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
      color: #333;
      transition: background 0.2s;
    }
    .attachment-btn:hover {
      background: #dee2e6;
    }
    .attachment-image-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: 4px;
      object-fit: cover;
    }
    .loading-attachments {
      color: #666;
      font-size: 0.875rem;
      padding: 0.5rem;
    }
    .error-attachments {
      color: #d32f2f;
      font-size: 0.875rem;
      padding: 0.5rem;
    }
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e9ecef;
    }
    .tab {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom-color: #1a1a2e;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìß EE-Mail Admin</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <select id="domain-selector" class="domain-selector" style="display: none;">
        <option value="">All Domains</option>
      </select>
      <span class="domain" id="domain">eternalgy.me</span>
    </div>
  </div>

  <div class="container">
    <div id="error"></div>
    
    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <h3>-</h3>
        <p>Total</p>
      </div>
      <div class="stat-card">
        <h3>-</h3>
        <p>Sent</p>
      </div>
      <div class="stat-card">
        <h3>-</h3>
        <p>Delivered</p>
      </div>
      <div class="stat-card">
        <h3>-</h3>
        <p>Opened</p>
      </div>
      <div class="stat-card">
        <h3>-</h3>
        <p>Bounced</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" onclick="openComposeModal('new')">‚úèÔ∏è Compose</button>
      <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
      <button class="btn btn-secondary" onclick="window.open('/api', '_blank')">üìã API Docs</button>
    </div>

    <div class="tabs" style="margin-bottom: 0;">
      <div class="tab active" id="tab-sent" onclick="switchEmailTab('sent')">üì§ Sent Emails</div>
      <div class="tab" id="tab-received" onclick="switchEmailTab('received')">üì• Received Emails</div>
    </div>

    <div class="email-list">
      <div class="email-list-header">
        <h3 id="email-list-title">Sent Emails</h3>
        <span id="email-count">Loading...</span>
      </div>
      <div id="email-list">
        <div class="loading">Loading emails...</div>
      </div>
    </div>
  </div>

  <!-- Email Detail Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Email Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="email-detail-header">
          <h2 id="modal-subject">-</h2>
          <div class="email-meta">
            <span><strong>From:</strong> <span id="modal-from">-</span></span>
            <span><strong>To:</strong> <span id="modal-to">-</span></span>
            <span id="modal-cc-row" style="display:none;"><strong>CC:</strong> <span id="modal-cc">-</span></span>
            <span><strong>Date:</strong> <span id="modal-date">-</span></span>
            <span><strong>Status:</strong> <span id="modal-status">-</span></span>
          </div>
        </div>
        <div class="attachments-section" id="attachments-section" style="display:none;">
          <h4>üìé Attachments (<span id="attachment-count">0</span>)</h4>
          <div class="attachments-list" id="attachments-list"></div>
        </div>
        <div class="email-actions" style="margin: 1rem 0; padding: 1rem 0; border-top: 1px solid #e9ecef; border-bottom: 1px solid #e9ecef;">
          <button class="btn btn-primary" onclick="replyEmail()" id="btn-reply">‚Ü©Ô∏è Reply</button>
          <button class="btn btn-secondary" onclick="replyAllEmail()" id="btn-reply-all" style="margin-left: 0.5rem;">‚Ü©Ô∏è Reply All</button>
          <button class="btn btn-secondary" onclick="forwardEmail()" id="btn-forward" style="margin-left: 0.5rem;">‚û°Ô∏è Forward</button>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab('html')">HTML</div>
          <div class="tab" onclick="switchTab('text')">Text</div>
        </div>
        <div id="refresh-content-btn" style="margin-bottom: 1rem; display: none;">
          <button class="btn btn-primary" onclick="refreshEmailContent()">
            üîÑ Fetch Content from Resend
          </button>
          <span style="color: #666; font-size: 0.875rem; margin-left: 0.5rem;">
            Content not loaded yet
          </span>
        </div>
        <div class="email-content" id="content-html">
          <iframe id="html-frame"></iframe>
        </div>
        <div class="email-content" id="content-text" style="display:none;">
          <pre id="text-content"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Compose/Reply Modal -->
  <div class="modal-overlay" id="compose-modal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3 id="compose-title">New Message</h3>
        <button class="modal-close" onclick="closeComposeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="compose-form" onsubmit="sendComposeEmail(event)">
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">Domain</label>
            <select id="compose-domain" onchange="updateComposeFrom()"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
              <!-- Options populated dynamically -->
            </select>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">From</label>
            <input type="text" id="compose-from" value="noreply@eternalgy.me" readonly 
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">To</label>
            <input type="text" id="compose-to" required
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
              placeholder="recipient@example.com">
          </div>
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <label style="color: #666; font-size: 0.875rem;">CC</label>
              <button type="button" onclick="toggleBcc()" style="background: none; border: none; color: #666; font-size: 0.875rem; cursor: pointer;">+ BCC</button>
            </div>
            <input type="text" id="compose-cc"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.25rem;"
              placeholder="cc@example.com, another@example.com">
          </div>
          <div style="margin-bottom: 1rem; display: none;" id="compose-bcc-row">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">BCC</label>
            <input type="text" id="compose-bcc"
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
              placeholder="bcc@example.com">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">Subject</label>
            <input type="text" id="compose-subject" required
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.875rem;">Message</label>
            <textarea id="compose-body" rows="10" required
              style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;"></textarea>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary" id="compose-send-btn">üìß Send</button>
            <button type="button" class="btn btn-secondary" onclick="closeComposeModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let currentEmail = null;
    let currentTab = 'sent';
    let receivedEmails = [];
    let sentEmails = [];
    let availableDomains = [];
    let selectedDomain = ''; // Empty string means all domains
    let domainSenders = {}; // Map of domain -> default sender

    async function fetchDomains() {
      try {
        const res = await fetch('/domains');
        const result = await res.json();
        
        if (result.success && result.data) {
          availableDomains = result.data;
          domainSenders = {};
          
          // Populate domain selector
          const selector = document.getElementById('domain-selector');
          const composeDomain = document.getElementById('compose-domain');
          
          // Clear existing options
          selector.innerHTML = '<option value="">All Domains</option>';
          composeDomain.innerHTML = '';
          
          result.data.forEach(d => {
            domainSenders[d.domain] = d.defaultSender;
            
            // Add to filter selector
            const option = document.createElement('option');
            option.value = d.domain;
            option.textContent = d.domain;
            selector.appendChild(option);
            
            // Add to compose selector
            const composeOption = document.createElement('option');
            composeOption.value = d.domain;
            composeOption.textContent = d.domain + (d.isPrimary ? ' (Primary)' : '');
            composeDomain.appendChild(composeOption);
          });
          
          // Show selector if multiple domains
          if (result.data.length > 1) {
            selector.style.display = 'block';
          }
          
          // Update header domain display
          if (result.data.length > 0) {
            const primary = result.data.find(d => d.isPrimary) || result.data[0];
            document.getElementById('domain').textContent = primary.domain;
            if (result.data.length > 1) {
              document.getElementById('domain').textContent += ` (+${result.data.length - 1})`;
            }
          }
          
          // Set initial compose from
          updateComposeFrom();
        }
      } catch (err) {
        console.error('Failed to load domains:', err);
      }
    }

    function updateComposeFrom() {
      const domain = document.getElementById('compose-domain').value;
      const fromInput = document.getElementById('compose-from');
      
      if (domain && domainSenders[domain]) {
        fromInput.value = domainSenders[domain];
      } else if (availableDomains.length > 0) {
        fromInput.value = availableDomains[0].defaultSender;
      }
    }

    async function fetchData() {
      try {
        // Build URLs with domain filter
        const sentUrl = selectedDomain ? `/emails?domain=${encodeURIComponent(selectedDomain)}` : '/emails';
        const receivedUrl = selectedDomain ? `/received-emails?domain=${encodeURIComponent(selectedDomain)}` : '/received-emails';
        
        const [statsRes, statsDomainRes, sentRes, receivedRes] = await Promise.all([
          fetch('/stats'),
          fetch('/stats/domains'),
          fetch(sentUrl),
          fetch(receivedUrl)
        ]);

        const stats = await statsRes.json();
        const statsDomain = await statsDomainRes.json();
        const sent = await sentRes.json();
        const received = await receivedRes.json();

        if (stats.success) {
          updateStats(stats.data);
        }
        if (statsDomain.success) {
          updateDomainStats(statsDomain.data);
        }
        if (sent.success) {
          sentEmails = sent.data;
        }
        if (received.success) {
          receivedEmails = received.data;
        }
        
        updateEmailList();
      } catch (err) {
        showError('Failed to load data: ' + err.message);
      }
    }

    function updateDomainStats(domainStats) {
      // Could add a domain breakdown section to the stats grid
      console.log('Domain stats:', domainStats);
    }

    function onDomainChange() {
      selectedDomain = document.getElementById('domain-selector').value;
      refreshData();
    }

    function switchEmailTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById('email-list-title').textContent = tab === 'sent' ? 'Sent Emails' : 'Received Emails';
      updateEmailList();
    }

    function updateStats(data) {
      const statsEl = document.getElementById('stats');
      if (data.note) {
        statsEl.innerHTML = '<div class="stat-card" style="grid-column: 1/-1;"><p>Database not configured</p></div>';
        return;
      }
      const stats = [
        { value: data.total, label: 'Total' },
        { value: data.sent, label: 'Sent' },
        { value: data.delivered, label: 'Delivered' },
        { value: data.opened, label: 'Opened' },
        { value: data.bounced, label: 'Bounced' }
      ];
      statsEl.innerHTML = stats.map(s => `
        <div class="stat-card">
          <h3>${s.value || 0}</h3>
          <p>${s.label}</p>
        </div>
      `).join('');
    }

    function updateEmailList() {
      const listEl = document.getElementById('email-list');
      const emails = currentTab === 'sent' ? sentEmails : receivedEmails;
      
      document.getElementById('email-count').textContent = `${emails.length} emails`;
      
      if (!emails || emails.length === 0) {
        listEl.innerHTML = `<div class="empty">No ${currentTab} emails found</div>`;
        return;
      }

      if (currentTab === 'sent') {
        listEl.innerHTML = emails.map(email => `
          <div class="email-item" onclick="viewSentEmail(${email.id})">
            <div class="email-from">
              ${email.from_email}
              <span class="status-badge status-${email.status}">${email.status}</span>
              ${selectedDomain === '' && email.domain ? `<span class="domain-tag">${email.domain}</span>` : ''}
            </div>
            <div class="email-subject">${email.subject}</div>
            <div class="email-date">${formatDate(email.sent_at)}</div>
          </div>
        `).join('');
      } else {
        listEl.innerHTML = emails.map(email => {
          const hasAttachments = email.attachments && email.attachments.length > 0;
          const attachmentIcon = hasAttachments ? ` üìé${email.attachments.length > 1 ? email.attachments.length : ''}` : '';
          return `
          <div class="email-item" onclick="viewReceivedEmail(${email.id})">
            <div class="email-from">${email.from_email}
              ${selectedDomain === '' && email.domain ? `<span class="domain-tag">${email.domain}</span>` : ''}
            </div>
            <div class="email-subject">${email.subject}${attachmentIcon}</div>
            <div class="email-date">${formatDate(email.received_at)}</div>
          </div>
        `;}).join('');
      }
    }

    function viewSentEmail(id) {
      const email = sentEmails.find(e => e.id === id);
      if (email) showEmailDetail(email, 'sent');
    }

    function viewReceivedEmail(id) {
      const email = receivedEmails.find(e => e.id === id);
      if (email) showEmailDetail(email, 'received');
    }

    function viewEmail(id) {
      if (currentTab === 'sent') {
        viewSentEmail(id);
      } else {
        viewReceivedEmail(id);
      }
    }

    // Current email's attachments
    let currentAttachments = [];

    function showEmailDetail(email, type) {
      currentEmail = email;
      currentAttachments = [];
      document.getElementById('modal-subject').textContent = email.subject;
      document.getElementById('modal-from').textContent = email.from_email;
      document.getElementById('modal-to').textContent = type === 'sent' ? email.to_email : (email.to_email || 'me@eternalgy.me');
      document.getElementById('modal-date').textContent = formatDate(type === 'sent' ? email.sent_at : email.received_at);
      
      const statusHtml = type === 'sent' 
        ? `<span class="status-badge status-${email.status}">${email.status}</span>`
        : '<span class="status-badge status-delivered">received</span>';
      document.getElementById('modal-status').innerHTML = statusHtml;
      
      // Show CC if present
      const ccRow = document.getElementById('modal-cc-row');
      const ccEmails = email.cc_emails || [];
      if (Array.isArray(ccEmails) && ccEmails.length > 0) {
        ccRow.style.display = 'inline';
        document.getElementById('modal-cc').textContent = ccEmails.join(', ');
      } else {
        ccRow.style.display = 'none';
      }
      
      // Hide reply buttons for sent emails
      const btnReply = document.getElementById('btn-reply');
      const btnReplyAll = document.getElementById('btn-reply-all');
      const btnForward = document.getElementById('btn-forward');
      
      if (type === 'sent') {
        btnReply.style.display = 'none';
        btnReplyAll.style.display = 'none';
        btnForward.style.display = 'none';
      } else {
        btnReply.style.display = 'inline-block';
        btnReplyAll.style.display = 'inline-block';
        btnForward.style.display = 'inline-block';
      }
      
      // Set content
      const htmlFrame = document.getElementById('html-frame');
      const hasContent = email.html_content || email.text_content;
      htmlFrame.srcdoc = email.html_content || '<p><em>No HTML content</em></p>';
      document.getElementById('text-content').textContent = email.text_content || '<no text content>';
      
      // Show refresh button for received emails without content
      const refreshBtn = document.getElementById('refresh-content-btn');
      if (type === 'received' && !hasContent && email.email_id) {
        refreshBtn.style.display = 'block';
      } else {
        refreshBtn.style.display = 'none';
      }
      
      // Load attachments for received emails
      const attachmentsSection = document.getElementById('attachments-section');
      if (type === 'received' && email.id) {
        loadAttachments(email.id);
      } else {
        attachmentsSection.style.display = 'none';
      }
      
      // Reset tab
      switchTab('html');
      
      document.getElementById('modal').classList.add('active');
    }

    async function loadAttachments(emailId) {
      const attachmentsSection = document.getElementById('attachments-section');
      const attachmentsList = document.getElementById('attachments-list');
      const attachmentCount = document.getElementById('attachment-count');
      
      attachmentsList.innerHTML = '<div class="loading-attachments">Loading attachments...</div>';
      attachmentsSection.style.display = 'block';
      
      try {
        const response = await fetch(`/received-emails/${emailId}/attachments`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          currentAttachments = result.data;
          attachmentCount.textContent = result.data.length;
          renderAttachments(result.data, emailId);
        } else {
          // Check if we have cached attachments in the email record
          const email = receivedEmails.find(e => e.id === emailId);
          if (email && email.attachments && email.attachments.length > 0) {
            // Show cached attachment names without download capability
            currentAttachments = email.attachments;
            attachmentCount.textContent = email.attachments.length;
            renderCachedAttachments(email.attachments);
          } else {
            attachmentsSection.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('Failed to load attachments:', err);
        // Try to show cached attachments
        const email = receivedEmails.find(e => e.id === emailId);
        if (email && email.attachments && email.attachments.length > 0) {
          currentAttachments = email.attachments;
          attachmentCount.textContent = email.attachments.length;
          renderCachedAttachments(email.attachments);
        } else {
          attachmentsSection.style.display = 'none';
        }
      }
    }

    function renderAttachments(attachments, emailId) {
      const attachmentsList = document.getElementById('attachments-list');
      
      attachmentsList.innerHTML = attachments.map(att => {
        const icon = getAttachmentIcon(att.content_type);
        const size = formatFileSize(att.size);
        const isImage = att.content_type && att.content_type.startsWith('image/');
        
        return `
          <div class="attachment-item" title="${escapeHtml(att.filename)}">
            <span class="attachment-icon">${icon}</span>
            <div class="attachment-info">
              <span class="attachment-name">${escapeHtml(att.filename)}</span>
              <span class="attachment-size">${size}</span>
            </div>
            <div class="attachment-actions">
              ${isImage ? `<button class="attachment-btn" onclick="viewAttachment('${emailId}', '${encodeURIComponent(att.filename)}', '${att.content_type}')" title="View">üëÅÔ∏è</button>` : ''}
              <button class="attachment-btn" onclick="downloadAttachmentFile('${emailId}', '${encodeURIComponent(att.filename)}')" title="Download">‚¨áÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCachedAttachments(attachments) {
      const attachmentsList = document.getElementById('attachments-list');
      
      attachmentsList.innerHTML = attachments.map(att => {
        const icon = getAttachmentIcon(att.content_type);
        const size = formatFileSize(att.size);
        
        return `
          <div class="attachment-item" title="${escapeHtml(att.filename)} (Download unavailable - click to retry)">
            <span class="attachment-icon">${icon}</span>
            <div class="attachment-info">
              <span class="attachment-name">${escapeHtml(att.filename)}</span>
              <span class="attachment-size">${size} (cached)</span>
            </div>
          </div>
        `;
      }).join('') + '<div class="loading-attachments">Refresh to enable downloads</div>';
    }

    function getAttachmentIcon(contentType) {
      if (!contentType) return 'üìé';
      if (contentType.startsWith('image/')) return 'üñºÔ∏è';
      if (contentType.startsWith('video/')) return 'üé¨';
      if (contentType.startsWith('audio/')) return 'üéµ';
      if (contentType.includes('pdf')) return 'üìÑ';
      if (contentType.includes('zip') || contentType.includes('compressed')) return 'üì¶';
      if (contentType.includes('word') || contentType.includes('document')) return 'üìù';
      if (contentType.includes('excel') || contentType.includes('sheet')) return 'üìä';
      if (contentType.includes('powerpoint') || contentType.includes('presentation')) return 'üìΩÔ∏è';
      if (contentType.includes('text')) return 'üìÉ';
      if (contentType.includes('json') || contentType.includes('xml')) return 'üîß';
      return 'üìé';
    }

    function formatFileSize(bytes) {
      if (!bytes || bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function viewAttachment(emailId, filename, contentType) {
      try {
        const url = `/attachments/${emailId}/${filename}`;
        
        // For images, open in new tab
        if (contentType && contentType.startsWith('image/')) {
          window.open(url, '_blank');
        } 
        // For PDFs, open in new tab
        else if (contentType && contentType.includes('pdf')) {
          window.open(url, '_blank');
        }
        // For other types, try to open or download
        else {
          window.open(url, '_blank');
        }
      } catch (err) {
        alert('‚ùå Failed to open attachment: ' + err.message);
      }
    }

    async function downloadAttachmentFile(emailId, filename) {
      try {
        const url = `/attachments/${emailId}/${filename}/download`;
        
        // Create a temporary link to trigger download
        const link = document.createElement('a');
        link.href = url;
        link.download = decodeURIComponent(filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        alert('‚ùå Failed to download attachment: ' + err.message);
      }
    }

    // Compose modal functions
    let composeMode = 'new'; // 'new', 'reply', 'reply-all', 'forward'
    
    function openComposeModal(mode = 'new', email = null) {
      composeMode = mode;
      const modal = document.getElementById('compose-modal');
      const title = document.getElementById('compose-title');
      const toInput = document.getElementById('compose-to');
      const ccInput = document.getElementById('compose-cc');
      const subjectInput = document.getElementById('compose-subject');
      const bodyInput = document.getElementById('compose-body');
      
      // Reset form
      document.getElementById('compose-form').reset();
      document.getElementById('compose-bcc-row').style.display = 'none';
      
      if (mode === 'new') {
        title.textContent = 'New Message';
        toInput.value = '';
        ccInput.value = '';
        subjectInput.value = '';
        bodyInput.value = '';
      } else if (email) {
        const emailData = email;
        const from = emailData.from_email;
        const to = emailData.to_email;
        const cc = emailData.cc_emails || [];
        const subject = emailData.subject || '';
        
        // Parse email addresses
        const fromEmail = extractEmail(from);
        const toEmails = to.split(',').map(e => extractEmail(e.trim())).filter(Boolean);
        
        if (mode === 'reply') {
          title.textContent = 'Reply';
          toInput.value = fromEmail;
          ccInput.value = '';
          subjectInput.value = subject.startsWith('Re:') ? subject : `Re: ${subject}`;
          bodyInput.value = formatReplyBody(emailData);
        } else if (mode === 'reply-all') {
          title.textContent = 'Reply All';
          toInput.value = fromEmail;
          // Add original To recipients (excluding yourself)
          const otherRecipients = toEmails.filter(e => !e.includes('eternalgy.me'));
          const otherCc = (Array.isArray(cc) ? cc : []).filter(e => !e.includes('eternalgy.me'));
          ccInput.value = [...otherRecipients, ...otherCc].join(', ');
          subjectInput.value = subject.startsWith('Re:') ? subject : `Re: ${subject}`;
          bodyInput.value = formatReplyBody(emailData);
        } else if (mode === 'forward') {
          title.textContent = 'Forward';
          toInput.value = '';
          ccInput.value = '';
          subjectInput.value = subject.startsWith('Fw:') ? subject : `Fw: ${subject}`;
          bodyInput.value = formatForwardBody(emailData);
        }
      }
      
      modal.classList.add('active');
    }
    
    function closeComposeModal() {
      document.getElementById('compose-modal').classList.remove('active');
    }
    
    function toggleBcc() {
      const row = document.getElementById('compose-bcc-row');
      row.style.display = row.style.display === 'none' ? 'block' : 'none';
    }
    
    function extractEmail(str) {
      if (!str) return '';
      const match = str.match(/<([^>]+)>/);
      return match ? match[1] : str;
    }
    
    function formatReplyBody(email) {
      const date = formatDate(email.received_at || email.sent_at);
      const from = email.from_email;
      const text = email.text_content || email.html_content?.replace(/<[^>]+>/g, '') || '';
      
      return `\n\nOn ${date}, ${from} wrote:\n> ${text.split('\n').join('\n> ')}`;
    }
    
    function formatForwardBody(email) {
      const date = formatDate(email.received_at || email.sent_at);
      const from = email.from_email;
      const to = email.to_email;
      const subject = email.subject;
      const text = email.text_content || email.html_content?.replace(/<[^>]+>/g, '') || '';
      
      return `\n\n---------- Forwarded message ----------\n` +
             `From: ${from}\n` +
             `Date: ${date}\n` +
             `Subject: ${subject}\n` +
             `To: ${to}\n\n` +
             text;
    }
    
    async function sendComposeEmail(event) {
      event.preventDefault();
      
      const btn = document.getElementById('compose-send-btn');
      btn.disabled = true;
      btn.textContent = 'üì§ Sending...';
      
      const domain = document.getElementById('compose-domain').value;
      const from = document.getElementById('compose-from').value;
      const to = document.getElementById('compose-to').value;
      const cc = document.getElementById('compose-cc').value;
      const bcc = document.getElementById('compose-bcc').value;
      const subject = document.getElementById('compose-subject').value;
      const body = document.getElementById('compose-body').value;
      
      const toArray = to.split(',').map(e => e.trim()).filter(Boolean);
      const ccArray = cc ? cc.split(',').map(e => e.trim()).filter(Boolean) : undefined;
      const bccArray = bcc ? bcc.split(',').map(e => e.trim()).filter(Boolean) : undefined;
      
      try {
        const response = await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            domain,
            from,
            to: toArray,
            cc: ccArray,
            bcc: bccArray,
            subject: subject,
            text: body,
            html: `<pre style="font-family: Arial, sans-serif; white-space: pre-wrap;">${escapeHtml(body)}</pre>`,
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('‚úÖ Email sent successfully!');
          closeComposeModal();
          refreshData();
        } else {
          alert('‚ùå Failed to send: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìß Send';
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function replyEmail() {
      if (!currentEmail) return;
      openComposeModal('reply', currentEmail);
    }
    
    function replyAllEmail() {
      if (!currentEmail) return;
      openComposeModal('reply-all', currentEmail);
    }
    
    function forwardEmail() {
      if (!currentEmail) return;
      openComposeModal('forward', currentEmail);
    }

    async function refreshEmailContent() {
      if (!currentEmail || !currentEmail.email_id) return;
      
      const btn = document.querySelector('#refresh-content-btn button');
      btn.disabled = true;
      btn.textContent = 'üîÑ Fetching...';
      
      try {
        const response = await fetch('/received-emails/fetch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email_id: currentEmail.email_id })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Refresh the email list to get updated content
          await fetchData();
          
          // Update current email in modal
          const updated = receivedEmails.find(e => e.id === currentEmail.id);
          if (updated && (updated.html_content || updated.text_content)) {
            currentEmail = updated;
            document.getElementById('html-frame').srcdoc = updated.html_content || '<p><em>No HTML content</em></p>';
            document.getElementById('text-content').textContent = updated.text_content || '<no text content>';
            document.getElementById('refresh-content-btn').style.display = 'none';
          }
          
          alert('‚úÖ Email content loaded!');
        } else {
          alert('‚ùå Failed: ' + result.error);
        }
      } catch (err) {
        alert('‚ùå Error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Fetch Content from Resend';
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    function switchTab(type) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[type === 'html' ? 0 : 1].classList.add('active');
      document.getElementById('content-html').style.display = type === 'html' ? 'block' : 'none';
      document.getElementById('content-text').style.display = type === 'text' ? 'block' : 'none';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString();
    }

    function showError(msg) {
      document.getElementById('error').innerHTML = `<div class="error">${msg}</div>`;
    }

    function refreshData() {
      document.getElementById('email-list').innerHTML = '<div class="loading">Loading...</div>';
      fetchData();
    }

    // Close modal on overlay click
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    // Domain selector change handler
    document.getElementById('domain-selector').addEventListener('change', onDomainChange);

    // Initial load
    fetchDomains();
    fetchData();
    // Refresh every 30 seconds
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
